# 1.åœ¨reactä¸­å¯ä»¥åšå“ªäº›æ€§èƒ½ä¼˜åŒ–ï¼Ÿ

- ä½¿ç”¨shouldComponentUpdateé¿å…ä¸éœ€è¦çš„æ¸²æŸ“ï¼Œä½†å¦‚æœå¯¹propså’Œstateåšæ·±æ¯”è¾ƒï¼Œä»£ä»·å¾ˆå¤§ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡è¿›è¡Œå–èˆ

- å°†propsè®¾ç½®ä¸ºæ•°ç»„æˆ–å¯¹è±¡

  åŸå› ï¼šæ¯æ¬¡è°ƒç”¨Reactç»„ä»¶éƒ½ä¼šåˆ›å»ºæ–°ç»„ä»¶ï¼Œå°±ç®—ä¼ å…¥çš„æ•°ç»„æˆ–å¯¹è±¡çš„å€¼éƒ½æ²¡æœ‰æ”¹å˜ï¼Œä»–ä»¬çš„å¼•ç”¨åœ°å€ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜

  ```
  ä¸æ¨è
  <button style={{color: 'red'}}>
  
  æ¨è
  const style = {color: 'red'}
  <button style={style} />
  ```

- å°†å‡½æ•°çš„ç»‘å®šç§»åŠ¨åˆ°æ„é€ å‡½æ•°å†…ï¼Œå¯ä»¥é¿å…æ¯æ¬¡éƒ½ç»‘å®šäº‹ä»¶

- ä½¿ç”¨immutableä¸å¯å˜æ•°æ®ï¼Œåœ¨æˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨å¼•ç”¨ç±»å‹æ—¶ï¼Œä¸ºäº†é¿å…å¯¹åŸå§‹æ•°æ®çš„å½±å“ï¼Œä¸€èˆ¬å»ºè®®ä½¿ç”¨shallowCopyå’ŒdeepCopyå¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯è¿™æ ·ä¼šé€ æˆCPUå’Œå†…å­˜çš„æµªè´¹ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨immutable, ä¼˜ç‚¹å¦‚ä¸‹

  - é™ä½äº†â€å¯å˜â€œå¸¦æ¥çš„å¤æ‚åº¦
  - èŠ‚çœå†…å­˜ï¼Œimmutableä½¿ç”¨ç»“æ„å…±äº«å°½é‡å¤ç”¨å†…å­˜ï¼Œæ²¡æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ä¼šè¿›è¡Œåƒåœ¾å›æ”¶
  - å¯ä»¥æ›´å¥½çš„åšæ’¤é”€/é‡åšï¼Œ å¤åˆ¶/ç²˜è´´ï¼Œæ—¶é—´æ—…è¡Œ
  - ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜
  - æ‹¥æŠ±å‡½æ•°å¼ç¼–ç¨‹

- ç»™å­ç»„ä»¶è®¾ç½®ä¸€ä¸ªå”¯ä¸€çš„key, å› ä¸ºåœ¨diffç®—æ³•ä¸­ï¼Œä¼šæœ‰keyä½œä¸ºå”¯ä¸€æ ‡è¯†ä¼˜åŒ–æ¸²æŸ“

# 2è¯´è¯´ä½ å¯¹è‡ªå®šä¹‰hookçš„ç†è§£

## è‡ªå®šä¹‰Hook

é€šè¿‡è‡ªå®šä¹‰Hook,å¯ä»¥å°†ç»„ä»¶é€»è¾‘æå–åˆ°å¯å¤ç”¨çš„å‡½æ•°ä¸­ã€‚

å¯ä»¥ç†è§£æˆHookå°±æ˜¯ç”¨æ¥æ”¾ä¸€äº›é‡å¤ä»£ç çš„å‡½æ•°

## æ€»ç»“

æ‰€è°“çš„è‡ªå®šä¹‰Hook, å®é™…ä¸Šæ˜¯æŠŠå¾ˆå¤šé‡å¤çš„é€»è¾‘éƒ½æ”¾åœ¨ä¸€ä¸ªå‡½æ•°é‡Œé¢ï¼Œé€šè¿‡é—­åŒ…çš„æ–¹å¼ç»™returnå‡ºæ¥ï¼Œè¿™æ˜¯éå¸¸é«˜çº§çš„æ–¹å¼ï¼Œç¨‹åºå‘˜å´‡å°šä»£ç ç®€æ´ï¼Œå¦‚æœè¯´ä»¥åä¸šåŠ¡å¼€å‘éœ€è¦å¤§é‡é‡å¤ä»£ç ï¼Œå°±å¯ä»¥å°†å®ƒå°è£…æˆè‡ªå®šä¹‰Hook

# 3è¯´è¯´ä½ å¯¹useMemoçš„ç†è§£

## å‰è¨€

æœ€è¿‘çœ‹äº†React hook useCallback å’Œ useMemoçš„æ–‡æ¡£å½“ä½†æ˜¯çœ‹å®Œæ˜¯ä¸€çŸ¥åŠè§£ï¼ˆæˆ‘çš„ç†è§£èƒ½åŠ›æœ‰ç‚¹å·®ğŸ¤£ï¼‰ï¼Œæ„Ÿè§‰è¿™ä¸¤ä¸ªapiéå¸¸é›·åŒï¼Œå¯¹äºä½¿ç”¨åœºæ™¯ä¸€æ—¶æ— æ³•æƒ³åˆ°ï¼Œå°±é™ä¸‹æ¥ç ”ç©¶ä¸€ä¸‹ï¼Œç‰¹æ­¤åˆ†äº«ä¸‹ï¼Œæˆ‘ä¼šæŒ‰ç…§ä»¥ä¸‹ç›®å½•åˆ†äº«

- useCallback
  - useCallback çš„å‚æ•°
  - useCallback è¿”å›å€¼
  - useCallback ä½¿ç”¨åœºæ™¯
- useMemo
  - useMemo çš„å‚æ•°
  - useMemo çš„è¿”å›å€¼
  - useMemo ä½¿ç”¨åœºæ™¯

------

## useCallback

çœ‹ä¸€ä¸‹ï¼ˆ**ä¸€å®šè¦çœ‹å®Œå“¦ï¼Œå¯¹ä¸‹é¢ç†è§£å¾ˆé‡è¦**ï¼‰ï¼Œä½¿ç”¨classå†™çˆ¶å­ç»„ä»¶åµŒå¥—ï¼Œçˆ¶ç»„ä»¶ä¼ é€’ä¸€ä¸ªæ–¹æ³•ç»™å­ç»„ä»¶çš„åœºæ™¯,ä¸‹é¢æ˜¯ä¸€ä¸ªä¸ç†æƒ³çš„å†™æ³•

```
  class ParentComponent extends React.Component {
    constructor(props) {
      super(props);
      this.state = {
        count: 0
      };
    }
    //è¿™æ˜¯é‡‡ç”¨ä¸ç†æƒ³çš„å†™æ³•
    handleChildren() {
      console.log('clicked ChildrenComponent');
    }
    //è¿™æ˜¯é‡‡ç”¨ä¸ç†æƒ³çš„å†™æ³•
    handleParent() {
      console.log('clicked ParentComponent');
      this.setState(preCount => ({ count: preCount + 1 }));
    }
  
    render() {
      return (
        <div>
         {/* è¿™æ˜¯é‡‡ç”¨ä¸ç†æƒ³çš„å†™æ³• */}
          <div
            onClick={() => {
              this.handleParent();
            }}
          >
            ParentComponent{' '}
          </div>
          {/* è¿™æ˜¯é‡‡ç”¨ä¸ç†æƒ³çš„å†™æ³• */}
          <ChildrenComponent
            handleChildren={() => {
              this.handleParent();
            }}
          />
        </div>
      );
    }
  }

class ChildrenComponent extends React.PureComponent {
render() {
  const { handleChildren } = this.props;
  console.log('ChildrenComponent rending');
  return <div onClick={handleChildren}>ChildrenComponent </div>;
}
}
å¤åˆ¶ä»£ç 
```

æœ‰äº›å°ä¼™ä¼´å…¶å®å·²ç»çœ‹åˆ°é—®é¢˜æ‰€åœ¨äº†ï¼Œé—®é¢˜å‡ºåœ¨æ¯æ¬¡ç‚¹å‡»ParentComponentå°±ä¼šå¯¼è‡´ChildrenComponentä¹Ÿæ¸²æŸ“ä¸€æ¬¡ï¼Œè™½ç„¶ChildrenComponenté‡‡ç”¨äº†PureComponent ä¼˜åŒ–



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/26/16f40f94c0039db6~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)

å½“ParentComponentç»„ä»¶çš„setateå‘ç”Ÿæ”¹å˜çš„æ—¶å€™ renderéƒ½ä¼šé‡æ–°æ¸²æŸ“ä¸€æ¬¡ï¼ŒChildrenComponentçš„å±æ€§ handleChildrenå±æ€§é‡‡ç”¨åŒ¿åå‡½æ•°èµ‹å€¼ï¼Œå¯¼è‡´æ¯æ¬¡çš„å¼•ç”¨åœ°å€ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆChildrenComponentä½¿ç”¨ç”¨PureComponent ä¼˜åŒ–æ˜¯æ— æ•ˆçš„



```
    {/* è¿™æ˜¯é‡‡ç”¨ä¸ç†æƒ³çš„å†™æ³• */}
    <ChildrenComponent
      handleChildren={() => {
        this.handleParent();
      }}
    />
å¤åˆ¶ä»£ç 
```

æ”¹æ­£ç‰ˆ

```
class ParentComponent extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      count: 0
    };
  }
  handleChildren = () => {
    console.log('clicked ChildrenComponent');
  };
  handleParent = () => {
    console.log('clicked ParentComponent');
    this.setState(preCount => ({ count: preCount + 1 }));
  };

  render() {
    return (
      <div>
        <div onClick={this.handleParent}>ParentComponent </div>
        <ChildrenComponent handleChildren={this.handleChildren} />
      </div>
    );
  }
}

class ChildrenComponent extends React.PureComponent {
  render() {
    const { handleChildren } = this.props;
    console.log('ChildrenComponent rending');
    return <div onClick={handleChildren}>ChildrenComponent </div>;
  }
}
å¤åˆ¶ä»£ç 
```

ç‚¹å‡»ParentComponentä¸ä¼šå¯¼è‡´ChildrenComponentä¹Ÿæ¸²æŸ“ï¼ŒçœŸæ­£çš„èµ·åˆ°äº†ä¼˜åŒ–çš„ä½œç”¨

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/26/16f41010355612b1~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)



æ‰¯äº†è¿™ä¹ˆå¤šäº†ï¼Œåªè¦ä½ èƒ½å¤Ÿæ˜ç™½ä¸Šé¢çš„é—®é¢˜é‚£ä¸ªuseCallbackçš„ä½œç”¨ä¹Ÿå°±æ˜ç™½äº†ï¼Œè¯ä¸å¤šè¯´çœ‹ä»£ç (hookçš„å†™æ³•)

### useCallback çš„å‚æ•°

éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°

- callbackï¼ˆä»…ä»…æ˜¯ä¸ªå‡½æ•°ï¼‰ï¼Œå¹¶æŠŠè¦åšäº‹æƒ…çš„å‡½æ•°æ”¾åœ¨callbackå‡½æ•°ä½“å†…æ‰§è¡Œ
- deps è¦åšäº‹æƒ…çš„å‡½æ•°éœ€è¦å¼•å…¥çš„å¤–éƒ¨å‚æ•°æˆ–è€…æ˜¯ä¾èµ–å‚æ•°

```
  const handleChildrenCallback = useCallback(() => {
    handleChildren();
  }, []);// å’±ä»¬ä¸éœ€è¦å°±ä¸è¦ä¼ å…¥
å¤åˆ¶ä»£ç 
```

### useCallback è¿”å›å€¼

è¿”å›ä¸€ä¸ª memoized å›è°ƒå‡½æ•°ã€‚åœ¨ä¾èµ–å‚æ•°ä¸å˜çš„æƒ…å†µä¸‹ï¼Œè¿”å›çš„å›è°ƒå‡½æ•°æ˜¯åŒä¸€ä¸ªå¼•ç”¨åœ°å€

```
æ³¨æ„ æ¯å½“ä¾èµ–å‚æ•°å‘ç”Ÿæ”¹å˜useCallbackå°±ä¼šè‡ªåŠ¨é‡æ–°è¿”å›ä¸€ä¸ªæ–°çš„ memoized å‡½æ•°ï¼ˆåœ°å€å‘ç”Ÿæ”¹å˜ï¼‰
å¤åˆ¶ä»£ç 
```

### useCallback ä½¿ç”¨åœºæ™¯

ä¸Šé¢çš„ä¼˜åŒ–å­ç»„ä»¶æ¸²æŸ“æ¬¡æ•°ï¼Œå°±æ˜¯useCallbackçš„ä½¿ç”¨åœºæ™¯ï¼ŒåºŸè¯ä¸è¯´å’±ä»¬çœ‹çœ‹ä½¿ç”¨æ€ä¹ˆåšåˆ°å­ç»„ä»¶çš„ä¼˜åŒ–ï¼Œå’±ä»¬å…ˆçœ‹æ²¡æœ‰ä½¿ç”¨useCallbackï¼Œå­ç»„ä»¶çš„æ¸²æŸ“

```
æ³¨æ„ memoå’ŒPureComponentåŠŸèƒ½ç›¸åŒ
å¤åˆ¶ä»£ç 
const ParentComponent = () => {
  const [count, setCount] = useState(0);
  const handleChildren = () => {
    console.log('clicked ChildrenComponent');
  };

  const handleParent = () => {
    console.log('clicked ParentComponent');
    setCount(preCount => preCount + 1);
  };

  return (
    <div>
      <div onClick={handleParent}>ParentComponent --count =={count} </div>
      <ChildrenComponent handleChildren={handleChildren} />
    </div>
  );
};

const ChildrenComponent = memo(({ handleChildren }) => {
  console.log('ChildrenComponent rending');
  return <div onClick={handleChildren}>ChildrenComponent </div>;
});

å¤åˆ¶ä»£ç 
```

æ¯æ¬¡ç‚¹å‡»ParentComponentå°±ä¼šå¯¼è‡´ChildrenComponentä¹Ÿæ¸²æŸ“ä¸€æ¬¡ï¼Œè™½ç„¶ChildrenComponenté‡‡ç”¨äº†memo ä¼˜åŒ–ï¼Œçœ‹å›¾

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/26/16f4114d64f725b8~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)

ä½¿ç”¨useCallbackï¼Œæ¥ä¼˜åŒ–ChildrenComponentçš„æ¸²æŸ“ï¼Œçœ‹ä»£ç 



```
const ParentComponent = () => {
  const [count, setCount] = useState(0);
  const handleChildren = () => {
    console.log('clicked ChildrenComponent');
  };
  const handleChildrenCallback = useCallback(() => {
    handleChildren();
  }, []);

  const handleParent = () => {
    console.log('clicked ParentComponent');
    setCount(preCount => preCount + 1);
  };

  return (
    <div>
      <div onClick={handleParent}>ParentComponent --count =={count} </div>
      <ChildrenComponent handleChildren={handleChildrenCallback} />
    </div>
  );
};

const ChildrenComponent = memo(({ handleChildren }) => {
  console.log('ChildrenComponent rending');
  return <div onClick={handleChildren}>ChildrenComponent </div>;
});
å¤åˆ¶ä»£ç 
```

ç‚¹å‡»ParentComponentä¸ä¼šå¯¼è‡´ChildrenComponentæ¸²æŸ“ï¼ŒçœŸæ­£çš„èµ·åˆ°äº†ä¼˜åŒ–çš„ä½œç”¨ ï¼Œçœ‹åŠ¨å›¾



![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/26/16f4117592b6774f~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)

ç¬¬äºŒå‚æ•°ä¼ å…¥å€¼å¹¶ä¸”å»è§¦å‘ChildrenComponentä¹Ÿæ¸²æŸ“,ä»£ç æ€è·¯æ˜¯æ¯ç‚¹å‡»ä¸‰æ¬¡å°±ä¼šè§¦å‘ChildrenComponentæ¸²æŸ“ä¸€æ¬¡



```
const ParentComponent = () => {
  const [count, setCount] = useState(1);
  const [updateChildrenComponentNum, setUpdateChildrenComponentNum] = useState(
    0
  );
  const handleChildren = updateChildrenComponentNum => {
    console.log(
      'clicked ChildrenComponent updateChildrenComponentNum ' +
        updateChildrenComponentNum
    );
  };
  const handleChildrenCallback = useCallback(() => {
    handleChildren(updateChildrenComponentNum);
  }, [updateChildrenComponentNum]);

  const handleParent = () => {
    console.log('clicked ParentComponent');
    setCount(preCount => preCount + 1);
    if (count % 3 === 0) setUpdateChildrenComponentNum(preNum => preNum + 1);
  };

  return (
    <div>
      <div onClick={handleParent}>ParentComponent --count =={count} </div>
      <ChildrenComponent handleChildren={handleChildrenCallback} />
    </div>
  );
};

const ChildrenComponent = memo(({ handleChildren }) => {
  console.log('ChildrenComponent rending');
  return <div onClick={handleChildren}>ChildrenComponent </div>;
});
å¤åˆ¶ä»£ç 
```

æ¯ç‚¹å‡»ä¸‰æ¬¡å°±ä¼šè§¦å‘ChildrenComponentæ¸²æŸ“ä¸€æ¬¡ çœ‹å›¾

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/26/16f4123c06487b95~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)

ğŸ¤”å¤§ä¼™åº”è¯¥æ˜ç™½äº†useCallbackçš„ä½œç”¨äº†ï¼Œé…åˆmemoç”¨äºä¼˜åŒ–å­ç»„ä»¶çš„æ¸²æŸ“æ¬¡æ•°



## useMemo

useMemoæœ‰æ˜¯çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯é¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½è¿›è¡Œé«˜å¼€é”€çš„è®¡ç®—çš„ä¼˜åŒ–çš„ç­–ç•¥ï¼Œ

### useMemo çš„å‚æ•°

éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°

- callbackï¼ˆä»…ä»…æ˜¯ä¸ªå‡½æ•°ï¼‰ï¼Œå¹¶æŠŠè¦åšäº‹æƒ…çš„å‡½æ•°æ”¾åœ¨callbackå‡½æ•°ä½“å†…æ‰§è¡Œï¼Œï¼ˆéœ€è¦æœ‰è¿”å›å€¼ï¼‰
- deps è¦åšäº‹æƒ…çš„å‡½æ•°éœ€è¦å¼•å…¥çš„å¤–éƒ¨å‚æ•°æˆ–è€…æ˜¯ä¾èµ–å‚æ•°

### useMemo çš„è¿”å›å€¼

- è¿”å›ä¸€ä¸ª memoized å€¼ã€‚åœ¨ä¾èµ–å‚æ•°ä¸å˜çš„çš„æƒ…å†µè¿”å›çš„æ˜¯ä¸Šæ¬¡ç¬¬ä¸€æ¬¡è®¡ç®—çš„å€¼

  ```
   æ³¨æ„ æ¯å½“ä¾èµ–å‚æ•°å‘ç”Ÿæ”¹å˜useMemoå°±ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—è¿”å›ä¸€ä¸ªæ–°çš„ memoizedå€¼
  å¤åˆ¶ä»£ç 
  ```

### useMemoä½¿ç”¨åœºæ™¯

- ä¼˜åŒ–é’ˆå¯¹äºå½“å‰ç»„ä»¶é«˜å¼€é”€çš„è®¡ç®—ï¼Œå…·æœ‰è®°å¿†åŠŸèƒ½

çœ‹ä»£ç ï¼Œå…ˆæ¼”ç¤ºæ²¡æœ‰ä½¿ç”¨useMemoï¼Œå‘ç° computeExpensiveValueæ¯æ¬¡éƒ½ä¼šé‡ç°è®¡ç®—ï¼Œé‡è§å¤§çš„è®¡ç®—é‡æ˜¯ä¼šå¾ˆåƒå†…å­˜

```
const ComputeComponent = () => {
  const [count, setCount] = useState(100);
  const [changeNum, setChangeNum] = useState(100);

  function computeExpensiveValue(count) {
    console.log('computeExpensiveValue è¢«æ‰§è¡Œ');
    //æ¯”è¾ƒå¤§è®¡ç®—
    const array = new Array(count).fill(count);
    return array.reduce((currentTotal, item) => {
      return currentTotal + item;
    }, 0);
  }
  const handleSetCount = () => {
    setCount(preCount => preCount * 2);
  };
  const handleChangeNum = () => {
    setChangeNum(preCount => preCount * 2);
  };
  const computeValue = computeExpensiveValue(count);
  return (
    <div>
      <div>{computeValue}</div>
      <div onClick={handleSetCount}>addCount{count} </div>
      <div onClick={handleChangeNum}> add changeNum {changeNum}</div>
    </div>
  );
};
å¤åˆ¶ä»£ç 
```

ä¸è®ºæˆ‘ç‚¹å‡» addCount è¿˜æ˜¯   add changeNum  computeExpensiveValueéƒ½ä¼šè¢«æ‰§è¡Œï¼Œçœ‹å›¾

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/26/16f414410d9b5b40~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)

å…¶å®æˆ‘ä»¬ä¸å¸Œæœ›åœ¨ä¸æ”¹å˜countå€¼çš„æ—¶å€™å»é‡æ–°æ‰§è¡ŒcomputeExpensiveValueï¼Œä½¿ç”¨useMemoï¼Œæ˜¯å¯ä»¥åšåˆ°ï¼Œå¼€ä»£ç 



```
const ComputeComponent = () => {
  const [count, setCount] = useState(100);
  const [changeNum, setChangeNum] = useState(100);
  const computeValue = useMemo(() => computeExpensiveValue(count), [count]);
  function computeExpensiveValue(count) {
    console.log('computeExpensiveValue è¢«æ‰§è¡Œ');
    //æ¯”è¾ƒå¤§è®¡ç®—
    const array = new Array(count).fill(count);
    return array.reduce((currentTotal, item) => {
      return currentTotal + item;
    }, 0);
  }
  const handleSetCount = () => {
    setCount(preCount => preCount * 2);
  };
  const handleChangeNum = () => {
    setChangeNum(preCount => preCount * 2);
  };
  return (
    <div>
      <div>{computeValue}</div>
      <div onClick={handleSetCount}>addCount{count} </div>
      <div onClick={handleChangeNum}> add changeNum {changeNum}</div>
    </div>
  );
};

å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬åªå¸Œæœ›åœ¨ç‚¹å‡»addCountæˆ–è€…æ˜¯countå˜åŒ–çš„æ—¶å€™å»é‡æ–°è®¡ç®—ï¼Œçœ‹å›¾

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/26/16f4147ad91ba2a0~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)



## ä¸åŒä¹‹å¤„

- useCallback ä¼˜åŒ–é’ˆå¯¹äºå­ç»„ä»¶æ¸²æŸ“

- useMemo ä¼˜åŒ–é’ˆå¯¹äºå½“å‰ç»„ä»¶é«˜å¼€é”€è®¡ç®—

  å‚è€ƒé“¾æ¥ï¼šhttps://juejin.cn/post/6844904032113278990
  



# 4 è¯´è¯´ä½ å¯¹useContextçš„ç†è§£

## å®šä¹‰

Reactæ–‡æ¡£å®˜ç½‘å¹¶æœªå¯¹`Context`ç»™å‡ºâ€œæ˜¯ä»€ä¹ˆâ€çš„å®šä¹‰ï¼Œæ›´å¤šæ˜¯æè¿°ä½¿ç”¨çš„`Context`çš„åœºæ™¯ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨`Context`ã€‚

å®˜ç½‘å¯¹äºä½¿ç”¨`Context`çš„åœºæ™¯æ˜¯è¿™æ ·æè¿°çš„ï¼š

> In Some Cases, you want to pass data through the component tree without having to pass the props down manuallys at every level. you can do this directly in React with the powerful "context" API.

ç®€å•è¯´å°±æ˜¯ï¼Œå½“ä½ ä¸æƒ³åœ¨ç»„ä»¶æ ‘ä¸­é€šè¿‡é€å±‚ä¼ é€’`props`æˆ–è€…`state`çš„æ–¹å¼æ¥ä¼ é€’æ•°æ®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨`Context`æ¥å®ç°**è·¨å±‚çº§**çš„ç»„ä»¶æ•°æ®ä¼ é€’ã€‚

## å¦‚ä½•ä½¿ç”¨Context

å¦‚æœè¦`Context`å‘æŒ¥ä½œç”¨ï¼Œéœ€è¦ç”¨åˆ°ä¸¤ç§ç»„ä»¶ï¼Œä¸€ä¸ªæ˜¯`Context`ç”Ÿäº§è€…(Provider)ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªçˆ¶èŠ‚ç‚¹ï¼Œå¦å¤–æ˜¯ä¸€ä¸ª`Context`çš„æ¶ˆè´¹è€…(Consumer)ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªå­èŠ‚ç‚¹ã€‚æ‰€ä»¥`Context`çš„ä½¿ç”¨åŸºäº**ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼**ã€‚

```
import React, {createContext, useState, useContext} from 'react';

const Context = createContext(0)

function Parent () {
  const [ count, setCount ] = useState(0)
  return (
    <div>
      ç‚¹å‡»æ¬¡æ•°: { count } 
      <button onClick={() => { setCount(count + 1)}}>ç‚¹æˆ‘</button>
      <Context.Provider value={count}>
        <Child></Child>
      </Context.Provider>
    </div>
    )
}

function Child () {
  const count = useContext(Context);
  return (
    <div>{ count }</div>
  )
}
```

### å‡ ä¸ªå¯ä»¥ç›´æ¥è·å–Contextçš„åœ°æ–¹

å®é™…ä¸Šï¼Œé™¤äº†å®ä¾‹çš„`context`å±æ€§(`this.context`)ï¼ŒReactç»„ä»¶è¿˜æœ‰å¾ˆå¤šä¸ªåœ°æ–¹å¯ä»¥ç›´æ¥è®¿é—®çˆ¶ç»„ä»¶æä¾›çš„`Context`ã€‚æ¯”å¦‚æ„é€ æ–¹æ³•ï¼š

- `constructor(props, context)`

æ¯”å¦‚ç”Ÿå‘½å‘¨æœŸï¼š

- `componentWillReceiveProps(nextProps, nextContext)`
- `shouldComponentUpdate(nextProps, nextState, nextContext)`
- `componetWillUpdate(nextProps, nextState, nextContext)`

å¯¹äºé¢å‘å‡½æ•°çš„æ— çŠ¶æ€ç»„ä»¶ï¼Œå¯ä»¥é€šè¿‡å‡½æ•°çš„å‚æ•°ç›´æ¥è®¿é—®ç»„ä»¶çš„`Context`ã€‚

```
const StatelessComponent = (props, context) => (
  ......
)
```

## æ€»ç»“

- ä½¿ç”¨createContextåˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡
- è®¾ç½®providerå¹¶é€šè¿‡valueæ¥å£ä¼ é€’stateæ•°æ®
- å±€éƒ¨ç»„ä»¶ä»valueæ¥å£ä¸­ä¼ é€’çš„æ•°æ®å¯¹è±¡ä¸­è·å–è¯»å†™æ¥å£



å‚è€ƒé“¾æ¥ï¼šhttps://juejin.cn/post/6844903566381940744

# 5.ä¸ºä»€ä¹ˆä¸èƒ½åœ¨å¾ªç¯ã€æ¡ä»¶æˆ–åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨Hooks?

1.é¦–å…ˆå½“æˆ‘ä»¬è¿™æ ·å†™æ—¶

```
const [name,setName] = useState('æœçš®')
const [address,setAddress] = useState('æ­å·')
```

æ¯ä¸€ä¸ªuseStateéƒ½ä¼šåœ¨å½“å‰ç»„ä»¶ä¸­åˆ›å»ºä¸€ä¸ªhookå¯¹è±¡  ï¼Œå¹¶ä¸”è¿™ä¸ªå¯¹è±¡ä¸­çš„nextå±æ€§å§‹ç»ˆæ‰§è¡Œä¸‹ä¸€ä¸ªuseStateçš„hookå¯¹è±¡
è¿™äº›å¯¹è±¡ä»¥ä¸€ç§ç±»ä¼¼é“¾è¡¨çš„å½¢å¼å­˜åœ¨ Fiber.memoizedState ä¸­
è€Œå‡½æ•°ç»„ä»¶å°±æ˜¯é€šè¿‡fiberè¿™ä¸ªæ•°æ®ç»“æ„æ¥å®ç°æ¯æ¬¡renderåname addressä¸ä¼šè¢«useStateé‡æ–°åˆå§‹åŒ–

æ­£æ˜¯å› ä¸ºhooksä¸­æ˜¯è¿™æ ·å­˜å‚¨stateçš„ æ‰€ä»¥æˆ‘ä»¬åªèƒ½åœ¨hooksçš„æ ¹ä½œç”¨åŸŸä¸­ä½¿ç”¨useStateï¼Œè€Œä¸èƒ½åœ¨æ¡ä»¶è¯­å¥å’Œå¾ªç¯ä¸­ä½¿ç”¨
å› ä¸ºæˆ‘ä»¬ä¸èƒ½æ¯æ¬¡éƒ½ä¿è¯æ¡ä»¶æˆ–å¾ªç¯è¯­å¥éƒ½ä¼šæ‰§è¡Œ

```
if (something) {
  const [state1] = useState(1)
}

// or

for (something) {
  const [state2] = useState(2)
}
```

2.fiber

æ¯ä¸€ä¸ªç»„ä»¶éƒ½ä¼šæœ‰ä¸€ä¸ªfiberå¯¹è±¡ï¼Œåœ¨fiberä¸­æˆ‘ä»¬ä¸»è¦å…³æ³¨memoizedStateè¿™ä¸ªå¯¹è±¡ï¼Œå®ƒå°±æ˜¯è°ƒç”¨å®ŒuseStateåå¯¹åº”çš„å­˜å‚¨stateçš„å¯¹è±¡

è°ƒç”¨useStateåè®¾ç½®åœ¨memoizedStateä¸Šçš„å¯¹è±¡é•¿è¿™æ ·ï¼šï¼ˆåˆå«Hookå¯¹è±¡ï¼‰

JavaScript

è¿™é‡Œé¢æˆ‘ä»¬æœ€éœ€è¦å…³å¿ƒçš„æ˜¯memoizedStateå’Œnextï¼ŒmemoizedStateæ˜¯ç”¨æ¥è®°å½•è¿™ä¸ªuseStateåº”è¯¥è¿”å›çš„ç»“æœçš„ï¼Œè€ŒnextæŒ‡å‘çš„æ˜¯ä¸‹ä¸€æ¬¡useStateå¯¹åº”çš„`Hookå¯¹è±¡ï¼Œå³

```
{
  baseState,
  next,  
  baseUpdate,
  queue,
  memoizedState
}
```



JavaScript

å¤åˆ¶ä»£ç 

```
hook1  ==>  Fiber.memoizedState
state1 === hook1.memoizedState
hook1.next  ==> hook2 
state2  ==> hook2.memoizedState
```

....

è‹¥æœ‰æ”¶è·ï¼Œå°±ç‚¹ä¸ªèµå§

# 6 ç®€å•ä»‹ç»ä¸‹reactä¸­çš„diffç®—æ³•

16ä¹‹å‰ï¼š

diffç®—æ³•ä¸»è¦åŸºäºä¸‰ä¸ªè§„å¾‹ï¼š

- DOMèŠ‚ç‚¹çš„è·¨å±‚çº§ç§»åŠ¨çš„æ“ä½œç‰¹åˆ«å°‘ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡
- æ‹¥æœ‰ç›¸åŒç±»çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆç›¸ä¼¼çš„æ ‘å½¢ç»“æ„ï¼Œæ‹¥æœ‰ä¸åŒç±»çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆä¸åŒçš„æ ‘å½¢ç»“æ„
- å¯¹äºåŒä¸€å±‚çº§çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡å”¯ä¸€çš„idè¿›è¡ŒåŒºåˆ†

## Tree diff

å› ä¸ºç¬¬ä¸€ç‚¹ï¼ŒDOMèŠ‚ç‚¹çš„è·¨çº§æ“ä½œæ¯”è¾ƒå°‘ï¼Œé‚£ä¹ˆdiffç®—æ³•åªä¼šå¯¹ç›¸åŒå±‚çº§çš„DOMèŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚

å¦‚æœå‘ç°èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆä¼šå°†è¯¥èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹å®Œå…¨åˆ é™¤ï¼Œä¸ä¼šå†ç»§ç»­æ¯”è¾ƒã€‚å¦‚æœå‡ºç°äº†DOMèŠ‚ç‚¹çš„è·¨å±‚çº§çš„ç§»åŠ¨æ“ä½œï¼Œé‚£ä¹ˆä¼šåˆ é™¤è¯¥èŠ‚ç‚¹ä»¥åŠå…¶æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œç„¶ååœ¨ç§»åŠ¨åçš„ä½ç½®é‡æ–°åˆ›å»º

## Component diff

å¦‚æœæ˜¯åŒä¸€ç±»å‹çš„ç»„ä»¶ï¼Œé‚£ä¹ˆä¼šç»§ç»­å¯¹æ¯”VMæ•°

å¦‚æœä¸æ˜¯åŒä¸€ç±»å‹çš„ç»„ä»¶ï¼Œé‚£ä¹ˆä¼šå°†å…¶å’Œå…¶å­èŠ‚ç‚¹å®Œå…¨æ›¿æ¢ï¼Œä¸ä¼šå†è¿›è¡Œæ¯”å¯¹

åŒä¸€ç±»å‹çš„ç»„ä»¶ï¼Œæœ‰å¯èƒ½VMæ²¡æœ‰ä»»ä½•çš„å˜åŒ–ï¼Œå¦‚æœå¯ä»¥ç¡®å®šçš„çŸ¥é“è¿™ç‚¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥èŠ‚çœå¤§é‡çš„diffæ—¶é—´ï¼Œ

æ‰€ä»¥ç”¨æˆ·å¯ä»¥è®¾ç½®shouldComponentUpdate()æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œdiffç®—æ³•

## Element diff

å½“èŠ‚ç‚¹å¤„äºåŒä¸€å±‚çº§çš„æ—¶å€™æ—¶ï¼Œæœ‰ä¸‰ç§æ“ä½œï¼šINSERT_MAKEUPæ’å…¥ã€MOVE_EXISTINGç§»åŠ¨ã€REMOVE_NODEåˆ é™¤

è¿™é‡ŒReactæœ‰ä¸€ä¸ªä¼˜åŒ–ç­–ç•¥ï¼Œå¯¹äºåŒä¸€å±‚çº§çš„åŒç»„å­èŠ‚ç‚¹ï¼Œæ·»åŠ å”¯ä¸€çš„keyè¿›è¡ŒåŒºåˆ†ã€‚è¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥åˆ¤æ–­å‡ºæ¥æ˜¯å¦æ˜¯ç§»åŠ¨èŠ‚ç‚¹ã€‚é€šè¿‡keyå‘ç°æ–°æ—§é›†åˆä¸­çš„èŠ‚ç‚¹éƒ½æ˜¯ç›¸åŒçš„èŠ‚ç‚¹ï¼Œå°±åªéœ€è¦è¿›è¡Œç§»åŠ¨æ“ä½œå°±å¯ä»¥ã€‚

# 7  redux

## ä¸€ã€æ˜¯ä»€ä¹ˆ

`React`æ˜¯ç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„ï¼Œå¸®åŠ©æˆ‘ä»¬è§£å†³æ¸²æŸ“`DOM`çš„è¿‡ç¨‹

è€Œåœ¨æ•´ä¸ªåº”ç”¨ä¸­ä¼šå­˜åœ¨å¾ˆå¤šä¸ªç»„ä»¶ï¼Œæ¯ä¸ªç»„ä»¶çš„`state`æ˜¯ç”±è‡ªèº«è¿›è¡Œç®¡ç†ï¼ŒåŒ…æ‹¬ç»„ä»¶å®šä¹‰è‡ªèº«çš„`state`ã€ç»„ä»¶ä¹‹é—´çš„é€šä¿¡é€šè¿‡`props`ä¼ é€’ã€ä½¿ç”¨`Context`å®ç°æ•°æ®å…±äº«

å¦‚æœè®©æ¯ä¸ªç»„ä»¶éƒ½å­˜å‚¨è‡ªèº«ç›¸å…³çš„çŠ¶æ€ï¼Œç†è®ºä¸Šæ¥è®²ä¸ä¼šå½±å“åº”ç”¨çš„è¿è¡Œï¼Œä½†åœ¨å¼€å‘åŠåç»­ç»´æŠ¤é˜¶æ®µï¼Œæˆ‘ä»¬å°†èŠ±è´¹å¤§é‡ç²¾åŠ›å»æŸ¥è¯¢çŠ¶æ€çš„å˜åŒ–è¿‡ç¨‹

è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå°†æ‰€æœ‰çš„çŠ¶æ€è¿›è¡Œé›†ä¸­ç®¡ç†ï¼Œå½“éœ€è¦æ›´æ–°çŠ¶æ€çš„æ—¶å€™ï¼Œä»…éœ€è¦å¯¹è¿™ä¸ªç®¡ç†é›†ä¸­å¤„ç†ï¼Œè€Œä¸ç”¨å»å…³å¿ƒçŠ¶æ€æ˜¯å¦‚ä½•åˆ†å‘åˆ°æ¯ä¸€ä¸ªç»„ä»¶å†…éƒ¨çš„

`redux`å°±æ˜¯ä¸€ä¸ªå®ç°ä¸Šè¿°é›†ä¸­ç®¡ç†çš„å®¹å™¨ï¼Œéµå¾ªä¸‰å¤§åŸºæœ¬åŸåˆ™ï¼š

- å•ä¸€æ•°æ®æº
- state æ˜¯åªè¯»çš„
- ä½¿ç”¨çº¯å‡½æ•°æ¥æ‰§è¡Œä¿®æ”¹

æ³¨æ„çš„æ˜¯ï¼Œ`redux`å¹¶ä¸æ˜¯åªåº”ç”¨åœ¨`react`ä¸­ï¼Œè¿˜ä¸å…¶ä»–ç•Œé¢åº“ä¸€èµ·ä½¿ç”¨ï¼Œå¦‚`Vue`

## äºŒã€å·¥ä½œåŸç†

`redux `è¦æ±‚æˆ‘ä»¬æŠŠæ•°æ®éƒ½æ”¾åœ¨ `store `å…¬å…±å­˜å‚¨ç©ºé—´

ä¸€ä¸ªç»„ä»¶æ”¹å˜äº† `store` é‡Œçš„æ•°æ®å†…å®¹ï¼Œå…¶ä»–ç»„ä»¶å°±èƒ½æ„ŸçŸ¥åˆ° `store `çš„å˜åŒ–ï¼Œå†æ¥å–æ•°æ®ï¼Œä»è€Œé—´æ¥çš„å®ç°äº†è¿™äº›æ•°æ®ä¼ é€’çš„åŠŸèƒ½

å·¥ä½œæµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

[![img](https://camo.githubusercontent.com/18662ca588464930308beb4081caa51d564154e8f18accaed8b567e51bad5f55/68747470733a2f2f7374617469632e7675652d6a732e636f6d2f32376232653933302d653536622d313165622d383566362d3666616337376330633962332e706e67)](https://camo.githubusercontent.com/18662ca588464930308beb4081caa51d564154e8f18accaed8b567e51bad5f55/68747470733a2f2f7374617469632e7675652d6a732e636f6d2f32376232653933302d653536622d313165622d383566362d3666616337376330633962332e706e67)

æ ¹æ®æµç¨‹å›¾ï¼Œå¯ä»¥æƒ³è±¡ï¼Œ`React Components` æ˜¯å€Ÿä¹¦çš„ç”¨æˆ·ï¼Œ `Action Creactor` æ˜¯å€Ÿä¹¦æ—¶è¯´çš„è¯(å€Ÿä»€ä¹ˆä¹¦)ï¼Œ `Store` æ˜¯å›¾ä¹¦é¦†ç®¡ç†å‘˜ï¼Œ`Reducer` æ˜¯è®°å½•æœ¬(å€Ÿä»€ä¹ˆä¹¦ï¼Œè¿˜ä»€ä¹ˆä¹¦ï¼Œåœ¨å“ªå„¿ï¼Œéœ€è¦æŸ¥ä¸€ä¸‹)ï¼Œ `state` æ˜¯ä¹¦ç±ä¿¡æ¯

æ•´ä¸ªæµç¨‹å°±æ˜¯å€Ÿä¹¦çš„ç”¨æˆ·éœ€è¦å…ˆå­˜åœ¨ï¼Œç„¶åéœ€è¦å€Ÿä¹¦ï¼Œéœ€è¦ä¸€å¥è¯æ¥æè¿°å€Ÿä»€ä¹ˆä¹¦ï¼Œå›¾ä¹¦é¦†ç®¡ç†å‘˜å¬åˆ°åéœ€è¦æŸ¥ä¸€ä¸‹è®°å½•æœ¬ï¼Œäº†è§£å›¾ä¹¦çš„ä½ç½®ï¼Œæœ€åå›¾ä¹¦é¦†ç®¡ç†å‘˜ä¼šæŠŠè¿™æœ¬ä¹¦ç»™åˆ°è¿™ä¸ªå€Ÿä¹¦äºº

è½¬æ¢ä¸ºä»£ç æ˜¯ï¼Œ`React Components` éœ€è¦è·å–ä¸€äº›æ•°æ®, ç„¶åå®ƒå°±å‘ŠçŸ¥ `Store` éœ€è¦è·å–æ•°æ®ï¼Œè¿™å°±æ˜¯å°±æ˜¯ `Action Creactor` , `Store` æ¥æ”¶åˆ°ä¹‹åå» `Reducer` æŸ¥ä¸€ä¸‹ï¼Œ `Reducer` ä¼šå‘Šè¯‰ `Store` åº”è¯¥ç»™è¿™ä¸ªç»„ä»¶ä»€ä¹ˆæ•°æ®

## ä¸‰ã€å¦‚ä½•ä½¿ç”¨

åˆ›å»ºä¸€ä¸ª`store`çš„å…¬å…±æ•°æ®åŒºåŸŸ

```
import { createStore } from 'redux' // å¼•å…¥ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æ–¹æ³•
const store = createStore() // åˆ›å»ºæ•°æ®çš„å…¬å…±å­˜å‚¨åŒºåŸŸï¼ˆç®¡ç†å‘˜ï¼‰
```

è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªè®°å½•æœ¬å»è¾…åŠ©ç®¡ç†æ•°æ®ï¼Œä¹Ÿå°±æ˜¯`reduecer`ï¼Œæœ¬è´¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸¤ä¸ªå‚æ•°`state`ï¼Œ`action`ï¼Œè¿”å›`state`

```
// è®¾ç½®é»˜è®¤å€¼
const initialState = {
  counter: 0
}

const reducer = (state = initialState, action) => {
}
```

ç„¶åå°±å¯ä»¥å°†è®°å½•æœ¬ä¼ é€’ç»™`store`ï¼Œä¸¤è€…å»ºç«‹è¿æ¥ã€‚å¦‚ä¸‹ï¼š

```
const store = createStore(reducer)
```

å¦‚æœæƒ³è¦è·å–`store`é‡Œé¢çš„æ•°æ®ï¼Œåˆ™é€šè¿‡`store.getState()`æ¥è·å–å½“å‰`state`

```
console.log(store.getState());
```

ä¸‹é¢å†çœ‹çœ‹å¦‚ä½•æ›´æ”¹`store`é‡Œé¢æ•°æ®ï¼Œæ˜¯é€šè¿‡`dispatch`æ¥æ´¾å‘`action`ï¼Œé€šå¸¸`action`ä¸­éƒ½ä¼šæœ‰`type`å±æ€§ï¼Œä¹Ÿå¯ä»¥æºå¸¦å…¶ä»–çš„æ•°æ®

```
store.dispatch({
  type: "INCREMENT"
})

store.dispath({
  type: "DECREMENT"
})

store.dispatch({
  type: "ADD_NUMBER",
  number: 5
})
```

ä¸‹é¢å†æ¥çœ‹çœ‹ä¿®æ”¹`reducer`ä¸­çš„å¤„ç†é€»è¾‘ï¼š

```
const reducer = (state = initialState, action) => {
  switch (action.type) {
    case "INCREMENT":
      return {...state, counter: state.counter + 1};
    case "DECREMENT":
      return {...state, counter: state.counter - 1};
    case "ADD_NUMBER":
      return {...state, counter: state.counter + action.number}
    default: 
      return state;
  }
}
```

æ³¨æ„ï¼Œ`reducer`æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œä¸éœ€è¦ç›´æ¥ä¿®æ”¹`state`

è¿™æ ·æ´¾å‘`action`ä¹‹åï¼Œæ—¢å¯ä»¥é€šè¿‡`store.subscribe`ç›‘å¬`store`çš„å˜åŒ–ï¼Œå¦‚ä¸‹ï¼š

```
store.subscribe(() => {
  console.log(store.getState());
})
```

åœ¨`React`é¡¹ç›®ä¸­ï¼Œä¼šæ­é…`react-redux`è¿›è¡Œä½¿ç”¨

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```
const redux = require('redux');

const initialState = {
  counter: 0
}

// åˆ›å»ºreducer
const reducer = (state = initialState, action) => {
  switch (action.type) {
    case "INCREMENT":
      return {...state, counter: state.counter + 1};
    case "DECREMENT":
      return {...state, counter: state.counter - 1};
    case "ADD_NUMBER":
      return {...state, counter: state.counter + action.number}
    default: 
      return state;
  }
}

// æ ¹æ®reduceråˆ›å»ºstore
const store = redux.createStore(reducer);

store.subscribe(() => {
  console.log(store.getState());
})

// ä¿®æ”¹storeä¸­çš„state
store.dispatch({
  type: "INCREMENT"
})
// console.log(store.getState());

store.dispatch({
  type: "DECREMENT"
})
// console.log(store.getState());

store.dispatch({
  type: "ADD_NUMBER",
  number: 5
})
// console.log(store.getState());
```

### å°ç»“

- createStoreå¯ä»¥å¸®åŠ©åˆ›å»º store
- store.dispatch å¸®åŠ©æ´¾å‘ action , action ä¼šä¼ é€’ç»™ store
- store.getState è¿™ä¸ªæ–¹æ³•å¯ä»¥å¸®åŠ©è·å– store é‡Œè¾¹æ‰€æœ‰çš„æ•°æ®å†…å®¹
- store.subscrible æ–¹æ³•è®¢é˜… store çš„æ”¹å˜ï¼Œåªè¦ store å‘ç”Ÿæ”¹å˜ï¼Œ store.subscrible è¿™ä¸ªå‡½æ•°æ¥æ”¶çš„è¿™ä¸ªå›è°ƒå‡½æ•°å°±ä¼šè¢«æ‰§è¡Œ

## å‚è€ƒæ–‡çŒ®

- https://cn.redux.js.org/docs/introduction/
- https://www.redux.org.cn/docs/basics/Actions.html
- https://lulujianglab.com/posts/å¤§ç™½è¯è§£æ Redux ã€ redux-thunk ã€redux-saga å’Œ react-redux

# 8 è¯´è¯´å¯¹Fiberæ¶æ„çš„ç†è§£ï¼Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜

## ä¸€ã€é—®é¢˜

`JavaScript `å¼•æ“å’Œé¡µé¢æ¸²æŸ“å¼•æ“ä¸¤ä¸ªçº¿ç¨‹æ˜¯äº’æ–¥çš„ï¼Œå½“å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åªèƒ½æŒ‚èµ·ç­‰å¾…

å¦‚æœ `JavaScript` çº¿ç¨‹é•¿æ—¶é—´åœ°å ç”¨äº†ä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆæ¸²æŸ“å±‚é¢çš„æ›´æ–°å°±ä¸å¾—ä¸é•¿æ—¶é—´åœ°ç­‰å¾…ï¼Œç•Œé¢é•¿æ—¶é—´ä¸æ›´æ–°ï¼Œä¼šå¯¼è‡´é¡µé¢å“åº”åº¦å˜å·®ï¼Œç”¨æˆ·å¯èƒ½ä¼šæ„Ÿè§‰åˆ°å¡é¡¿

è€Œè¿™ä¹Ÿæ­£æ˜¯ `React 15` çš„ `Stack Reconciler `æ‰€é¢ä¸´çš„é—®é¢˜ï¼Œå½“ `React `åœ¨æ¸²æŸ“ç»„ä»¶æ—¶ï¼Œä»å¼€å§‹åˆ°æ¸²æŸ“å®Œæˆæ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸€æ°”å‘µæˆçš„ï¼Œæ— æ³•ä¸­æ–­

å¦‚æœç»„ä»¶è¾ƒå¤§ï¼Œé‚£ä¹ˆ`js`çº¿ç¨‹ä¼šä¸€ç›´æ‰§è¡Œï¼Œç„¶åç­‰åˆ°æ•´æ£µ`VDOM`æ ‘è®¡ç®—å®Œæˆåï¼Œæ‰ä¼šäº¤ç»™æ¸²æŸ“çš„çº¿ç¨‹

è¿™å°±ä¼šå¯¼è‡´ä¸€äº›ç”¨æˆ·äº¤äº’ã€åŠ¨ç”»ç­‰ä»»åŠ¡æ— æ³•ç«‹å³å¾—åˆ°å¤„ç†ï¼Œå¯¼è‡´å¡é¡¿çš„æƒ…å†µ

[![img](https://camo.githubusercontent.com/29e98a4c53728c2c962b586f68215dedf30cfd85dd97699c23689a49181f0db4/68747470733a2f2f7374617469632e7675652d6a732e636f6d2f35656233613835302d656432342d313165622d616239302d6439616538313462323430642e706e67)](https://camo.githubusercontent.com/29e98a4c53728c2c962b586f68215dedf30cfd85dd97699c23689a49181f0db4/68747470733a2f2f7374617469632e7675652d6a732e636f6d2f35656233613835302d656432342d313165622d616239302d6439616538313462323430642e706e67)

## äºŒã€æ˜¯ä»€ä¹ˆ

React Fiber æ˜¯ Facebook èŠ±è´¹ä¸¤å¹´ä½™æ—¶é—´å¯¹ React åšå‡ºçš„ä¸€ä¸ªé‡å¤§æ”¹å˜ä¸ä¼˜åŒ–ï¼Œæ˜¯å¯¹ React æ ¸å¿ƒç®—æ³•çš„ä¸€æ¬¡é‡æ–°å®ç°ã€‚ä»Facebookåœ¨ React Conf 2017 ä¼šè®®ä¸Šç¡®è®¤ï¼ŒReact Fiber åœ¨React 16 ç‰ˆæœ¬å‘å¸ƒ

åœ¨`react`ä¸­ï¼Œä¸»è¦åšäº†ä»¥ä¸‹çš„æ“ä½œï¼š

- ä¸ºæ¯ä¸ªå¢åŠ äº†ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡å¯ä»¥ä¸­æ–­ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚ç„¶åå†é‡æ–°ï¼Œæ³¨æ„æ˜¯é‡æ–°æ‰§è¡Œä¼˜å…ˆçº§ä½çš„ä»»åŠ¡
- å¢åŠ äº†å¼‚æ­¥ä»»åŠ¡ï¼Œè°ƒç”¨requestIdleCallback apiï¼Œæµè§ˆå™¨ç©ºé—²çš„æ—¶å€™æ‰§è¡Œ
- dom diffæ ‘å˜æˆäº†é“¾è¡¨ï¼Œä¸€ä¸ªdomå¯¹åº”ä¸¤ä¸ªfiberï¼ˆä¸€ä¸ªé“¾è¡¨ï¼‰ï¼Œå¯¹åº”ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œè¿™éƒ½æ˜¯ä¸ºæ‰¾åˆ°è¢«ä¸­æ–­çš„ä»»åŠ¡ï¼Œé‡æ–°æ‰§è¡Œ

ä»æ¶æ„è§’åº¦æ¥çœ‹ï¼Œ`Fiber` æ˜¯å¯¹ `React `æ ¸å¿ƒç®—æ³•ï¼ˆå³è°ƒå’Œè¿‡ç¨‹ï¼‰çš„é‡å†™

ä»ç¼–ç è§’åº¦æ¥çœ‹ï¼Œ`Fiber `æ˜¯ `React `å†…éƒ¨æ‰€å®šä¹‰çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯ `Fiber `æ ‘ç»“æ„çš„èŠ‚ç‚¹å•ä½ï¼Œä¹Ÿå°±æ˜¯ `React 16` æ–°æ¶æ„ä¸‹çš„è™šæ‹Ÿ`DOM`

ä¸€ä¸ª `fiber `å°±æ˜¯ä¸€ä¸ª `JavaScript `å¯¹è±¡ï¼ŒåŒ…å«äº†å…ƒç´ çš„ä¿¡æ¯ã€è¯¥å…ƒç´ çš„æ›´æ–°æ“ä½œé˜Ÿåˆ—ã€ç±»å‹ï¼Œå…¶æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

```
type Fiber = {
  // ç”¨äºæ ‡è®°fiberçš„WorkTagç±»å‹ï¼Œä¸»è¦è¡¨ç¤ºå½“å‰fiberä»£è¡¨çš„ç»„ä»¶ç±»å‹å¦‚FunctionComponentã€ClassComponentç­‰
  tag: WorkTag,
  // ReactElementé‡Œé¢çš„key
  key: null | string,
  // ReactElement.typeï¼Œè°ƒç”¨`createElement`çš„ç¬¬ä¸€ä¸ªå‚æ•°
  elementType: any,
  // The resolved function/class/ associated with this fiber.
  // è¡¨ç¤ºå½“å‰ä»£è¡¨çš„èŠ‚ç‚¹ç±»å‹
  type: any,
  // è¡¨ç¤ºå½“å‰FiberNodeå¯¹åº”çš„elementç»„ä»¶å®ä¾‹
  stateNode: any,

  // æŒ‡å‘ä»–åœ¨FiberèŠ‚ç‚¹æ ‘ä¸­çš„`parent`ï¼Œç”¨æ¥åœ¨å¤„ç†å®Œè¿™ä¸ªèŠ‚ç‚¹ä¹‹åå‘ä¸Šè¿”å›
  return: Fiber | null,
  // æŒ‡å‘è‡ªå·±çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
  child: Fiber | null,
  // æŒ‡å‘è‡ªå·±çš„å…„å¼Ÿç»“æ„ï¼Œå…„å¼ŸèŠ‚ç‚¹çš„returnæŒ‡å‘åŒä¸€ä¸ªçˆ¶èŠ‚ç‚¹
  sibling: Fiber | null,
  index: number,

  ref: null | (((handle: mixed) => void) & { _stringRef: ?string }) | RefObject,

  // å½“å‰å¤„ç†è¿‡ç¨‹ä¸­çš„ç»„ä»¶propså¯¹è±¡
  pendingProps: any,
  // ä¸Šä¸€æ¬¡æ¸²æŸ“å®Œæˆä¹‹åçš„props
  memoizedProps: any,

  // è¯¥Fiberå¯¹åº”çš„ç»„ä»¶äº§ç”Ÿçš„Updateä¼šå­˜æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢
  updateQueue: UpdateQueue<any> | null,

  // ä¸Šä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™çš„state
  memoizedState: any,

  // ä¸€ä¸ªåˆ—è¡¨ï¼Œå­˜æ”¾è¿™ä¸ªFiberä¾èµ–çš„context
  firstContextDependency: ContextDependency<mixed> | null,

  mode: TypeOfMode,

  // Effect
  // ç”¨æ¥è®°å½•Side Effect
  effectTag: SideEffectTag,

  // å•é“¾è¡¨ç”¨æ¥å¿«é€ŸæŸ¥æ‰¾ä¸‹ä¸€ä¸ªside effect
  nextEffect: Fiber | null,

  // å­æ ‘ä¸­ç¬¬ä¸€ä¸ªside effect
  firstEffect: Fiber | null,
  // å­æ ‘ä¸­æœ€åä¸€ä¸ªside effect
  lastEffect: Fiber | null,

  // ä»£è¡¨ä»»åŠ¡åœ¨æœªæ¥çš„å“ªä¸ªæ—¶é—´ç‚¹åº”è¯¥è¢«å®Œæˆï¼Œä¹‹åç‰ˆæœ¬æ”¹åä¸º lanes
  expirationTime: ExpirationTime,

  // å¿«é€Ÿç¡®å®šå­æ ‘ä¸­æ˜¯å¦æœ‰ä¸åœ¨ç­‰å¾…çš„å˜åŒ–
  childExpirationTime: ExpirationTime,

  // fiberçš„ç‰ˆæœ¬æ± ï¼Œå³è®°å½•fiberæ›´æ–°è¿‡ç¨‹ï¼Œä¾¿äºæ¢å¤
  alternate: Fiber | null,
}
```

## ä¸‰ã€å¦‚ä½•è§£å†³

`Fiber`æŠŠæ¸²æŸ“æ›´æ–°è¿‡ç¨‹æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡ï¼Œæ¯æ¬¡åªåšä¸€å°éƒ¨åˆ†ï¼Œåšå®Œçœ‹æ˜¯å¦è¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Œå¦‚æœæœ‰ç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼›å¦‚æœæ²¡æœ‰ï¼ŒæŒ‚èµ·å½“å‰ä»»åŠ¡ï¼Œå°†æ—¶é—´æ§åˆ¶æƒäº¤ç»™ä¸»çº¿ç¨‹ï¼Œç­‰ä¸»çº¿ç¨‹ä¸å¿™çš„æ—¶å€™åœ¨ç»§ç»­æ‰§è¡Œ

å³å¯ä»¥ä¸­æ–­ä¸æ¢å¤ï¼Œæ¢å¤åä¹Ÿå¯ä»¥å¤ç”¨ä¹‹å‰çš„ä¸­é—´çŠ¶æ€ï¼Œå¹¶ç»™ä¸åŒçš„ä»»åŠ¡èµ‹äºˆä¸åŒçš„ä¼˜å…ˆçº§ï¼Œå…¶ä¸­æ¯ä¸ªä»»åŠ¡æ›´æ–°å•å…ƒä¸º `React Element` å¯¹åº”çš„ `Fiber `èŠ‚ç‚¹

å®ç°çš„ä¸Šè¿°æ–¹å¼çš„æ˜¯`requestIdleCallback`æ–¹æ³•

`window.requestIdleCallback()`æ–¹æ³•å°†åœ¨æµè§ˆå™¨çš„ç©ºé—²æ—¶æ®µå†…è°ƒç”¨çš„å‡½æ•°æ’é˜Ÿã€‚è¿™ä½¿å¼€å‘è€…èƒ½å¤Ÿåœ¨ä¸»äº‹ä»¶å¾ªç¯ä¸Šæ‰§è¡Œåå°å’Œä½ä¼˜å…ˆçº§å·¥ä½œï¼Œè€Œä¸ä¼šå½±å“å»¶è¿Ÿå…³é”®äº‹ä»¶ï¼Œå¦‚åŠ¨ç”»å’Œè¾“å…¥å“åº”

é¦–å…ˆ React ä¸­ä»»åŠ¡åˆ‡å‰²ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œåˆ†æ‰¹å®Œæˆã€‚åœ¨å®Œæˆä¸€éƒ¨åˆ†ä»»åŠ¡ä¹‹åï¼Œå°†æ§åˆ¶æƒäº¤å›ç»™æµè§ˆå™¨ï¼Œè®©æµè§ˆå™¨æœ‰æ—¶é—´å†è¿›è¡Œé¡µé¢çš„æ¸²æŸ“ã€‚ç­‰æµè§ˆå™¨å¿™å®Œä¹‹åæœ‰å‰©ä½™æ—¶é—´ï¼Œå†ç»§ç»­ä¹‹å‰ React æœªå®Œæˆçš„ä»»åŠ¡ï¼Œæ˜¯ä¸€ç§åˆä½œå¼è°ƒåº¦ã€‚

è¯¥å®ç°è¿‡ç¨‹æ˜¯åŸºäº `Fiber `èŠ‚ç‚¹å®ç°ï¼Œä½œä¸ºé™æ€çš„æ•°æ®ç»“æ„æ¥è¯´ï¼Œæ¯ä¸ª `Fiber` èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ª `React element`ï¼Œä¿å­˜äº†è¯¥ç»„ä»¶çš„ç±»å‹ï¼ˆå‡½æ•°ç»„ä»¶/ç±»ç»„ä»¶/åŸç”Ÿç»„ä»¶ç­‰ç­‰ï¼‰ã€å¯¹åº”çš„ DOM èŠ‚ç‚¹ç­‰ä¿¡æ¯ã€‚

ä½œä¸ºåŠ¨æ€çš„å·¥ä½œå•å…ƒæ¥è¯´ï¼Œæ¯ä¸ª `Fiber` èŠ‚ç‚¹ä¿å­˜äº†æœ¬æ¬¡æ›´æ–°ä¸­è¯¥ç»„ä»¶æ”¹å˜çš„çŠ¶æ€ã€è¦æ‰§è¡Œçš„å·¥ä½œã€‚

æ¯ä¸ª Fiber èŠ‚ç‚¹æœ‰ä¸ªå¯¹åº”çš„ `React element`ï¼Œå¤šä¸ª `Fiber `èŠ‚ç‚¹æ ¹æ®å¦‚ä¸‹ä¸‰ä¸ªå±æ€§æ„å»ºä¸€é¢—æ ‘ï¼š

```
// æŒ‡å‘çˆ¶çº§FiberèŠ‚ç‚¹
this.return = null
// æŒ‡å‘å­FiberèŠ‚ç‚¹
this.child = null
// æŒ‡å‘å³è¾¹ç¬¬ä¸€ä¸ªå…„å¼ŸFiberèŠ‚ç‚¹
this.sibling = null
```

é€šè¿‡è¿™äº›å±æ€§å°±èƒ½æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ‰§è¡Œç›®æ ‡